import{f as l,r as c,j as e,u as L,L as b}from"./index-5d20dca2.js";import{u}from"./useAuthContext-7152e344.js";import{h as m,F as d,f as g,N as w,i as v,L as U}from"./Layout-00d27bdb.js";import{u as p}from"./useMutation-46fd2380.js";import{S}from"./SectionHeading-7df4f79a.js";async function y(s,t){const n=new FormData;return n.append("username",s),n.append("password",t),await l({endpoint:"/login",method:"POST",data:n,contentType:"multipart/form-data"})}function E(){return p(({username:s,password:t})=>y(s,t),{onError:s=>{throw console.error("Login failed:",s),new Error("Invalid username or password")}})}const I=()=>{const[s,t]=c.useState(""),[n,r]=c.useState(""),[a,i]=c.useState(""),{setIsLoggedIn:h,setLoginAttempted:x}=u(),f=E(),j=o=>{o.preventDefault(),i(""),f.mutate({username:s,password:n},{onSuccess:()=>{h(!0),x(!0)},onError:()=>{i("Invalid username or password")}})};return e.jsxs("form",{id:"form",onSubmit:j,children:[e.jsx(m,{headingText:"Fill out the form to login:"}),e.jsxs("div",{className:"input-box",children:[e.jsx("label",{htmlFor:"username",children:"Username/Email:"}),e.jsx("input",{type:"text",id:"username",value:s,onChange:o=>t(o.target.value),autoComplete:"username"})]}),e.jsxs("div",{className:"input-box",children:[e.jsx("label",{htmlFor:"password",children:"Password:"}),e.jsx("input",{type:"password",id:"password",value:n,onChange:o=>r(o.target.value),autoComplete:"current-password"})]}),a&&e.jsx("p",{className:"error",children:a}),e.jsxs("button",{className:"btn btn-primary btn-nav",type:"submit",children:["Login ",e.jsx(d,{icon:g,className:"icon"})]})]})};function N(){const{setIsLoggedIn:s}=u();return{logoutUser:p(async()=>{await l({endpoint:"/logout",method:"POST"})},{onSuccess:()=>{s(!1)}})}}const F=()=>{const{logoutUser:s}=N(),t=()=>{s.mutate()};return e.jsx("ul",{className:"nav-button",children:e.jsx(w,{to:"/login",icon:e.jsx(d,{icon:v}),label:"Logout",onClick:t})})};async function C(s){try{return await l({endpoint:"/current_user",method:"GET",token:s})}catch(t){console.error("Failed to fetch current user:",t)}}const T=({token:s})=>{const{isLoggedIn:t,loginAttempted:n}=u(),{data:r,isLoading:a,error:i}=L(["currentUser",s],()=>C(s),{enabled:t&&n,retry:!1,staleTime:1e3*60*60});return t?a?e.jsx("div",{id:"login",children:e.jsx(b,{})}):i||!r?e.jsx("div",{children:"Error fetching current user"}):e.jsxs("div",{className:"current-user",children:[e.jsx(m,{headingText:`Welcome, ${r.username}`}),e.jsxs("p",{children:["Username: ",r.username]}),e.jsxs("p",{children:["Email: ",r.email]}),e.jsx(F,{})]}):null},B=()=>{const{isLoggedIn:s}=u();return e.jsx(U,{children:e.jsxs("section",{id:"login",children:[e.jsx(S,{headingText:"Primal Formulas Login",buttonLabel:"Continue Shopping",buttonUrl:"/Shop",buttonIcon:e.jsx(d,{icon:g,className:"icon"})}),s===!1?e.jsx(I,{}):e.jsx(T,{isLoggedIn:s,token:""})]})})};export{B as Login,B as default};
